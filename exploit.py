import numpy as np

def relu(x):
    return np.maximum(0.0, x)

def softmax(x, axis=-1):
    x = x - np.max(x, axis=axis, keepdims=True)  # numerical stability
    exp_x = np.exp(x)
    return exp_x / np.sum(exp_x, axis=axis, keepdims=True)

def linear(x, W, b):
    return x @ W.T + b
class ActorNumpy:
    def __init__(self, npz_path):
        p = np.load(npz_path)

        self.W0, self.b0 = p["net.0.weight"], p["net.0.bias"]
        self.W1, self.b1 = p["net.2.weight"], p["net.2.bias"]
        self.W2, self.b2 = p["net.5.weight"], p["net.5.bias"]
        self.W3, self.b3 = p["net.8.weight"], p["net.8.bias"]
        self.W4, self.b4 = p["net.11.weight"], p["net.11.bias"]

    def forward(self, x):
        """
        x: shape (batch, state_dim)
        """
        x = relu(linear(x, self.W0, self.b0))
        x = relu(linear(x, self.W1, self.b1))
        x = relu(linear(x, self.W2, self.b2))
        x = relu(linear(x, self.W3, self.b3))
        x = linear(x, self.W4, self.b4)
        return softmax(x, axis=-1)

actor_np = ActorNumpy("actor_params.npz")
state_dim = 11
state = np.random.randn(1, state_dim)
action_probs = actor_np.forward(state)

print(action_probs)
print(action_probs.sum())  # â‰ˆ 1.0

from visu_tool2 import visualize_mother_grid_numpy
from mothergrid import MotherGrid
from ResourceEnv import ResourceEnvFromGrid

mother = MotherGrid(grid=10,n_enemies=3)
env = ResourceEnvFromGrid(mother)   # or ResourceEnvFromGrid
state_dim = env.reset().shape[0]
print("state dim", state_dim)
action_dim = 4
#actor_resource = Actor_resource(state_dim, action_dim).to(device)
#actor_resource.load_state_dict(torch.load("weights_resource/actor_4000.pt",weights_only=True))
visualize_mother_grid_numpy(env, actor_numpy=actor_np)
